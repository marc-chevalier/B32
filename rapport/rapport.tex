\input{src/macros.tex}

\title{Cryptanalyse linéaire}
\author{
    William \textsc{Aufort}\\
    Marc \textsc{Chevalier}
}
\date{\today}

\begin{document}
\maketitle

\section*{Question 2}

Notre programme nous donne la matrice $L$ suivante :

\setcounter{MaxMatrixCols}{16}
\[ L = \quad \begin{pmatrix}
16 & 8 & 8 & 8 & 8 & 8 & 8 & 8 & 8 & 8 & 8 & 8 & 8 & 8 & 8 & 8 \\
8 & 10 & 8 & 6 & 8 & 14 & 8 & 10 & 10 & 8 & 6 & 8 & 6 & 8 & 10 & 8 \\
8 & 4 & 8 & 8 & 6 & 10 & 6 & 6 & 8 & 8 & 4 & 8 & 10 & 10 & 6 & 10 \\
8 & 6 & 8 & 6 & 6 & 8 & 6 & 8 & 10 & 8 & 10 & 8 & 8 & 10 & 8 & 2 \\
8 & 10 & 8 & 10 & 8 & 6 & 8 & 6 & 14 & 8 & 6 & 8 & 10 & 8 & 10 & 8 \\
8 & 8 & 4 & 8 & 8 & 8 & 12 & 8 & 8 & 12 & 8 & 8 & 8 & 12 & 8 & 8 \\
8 & 10 & 4 & 10 & 10 & 8 & 6 & 8 & 6 & 4 & 6 & 8 & 8 & 10 & 8 & 6 \\
8 & 8 & 8 & 8 & 10 & 10 & 10 & 2 & 8 & 8 & 8 & 8 & 6 & 6 & 6 & 6 \\
8 & 4 & 6 & 6 & 10 & 6 & 8 & 8 & 8 & 8 & 6 & 10 & 6 & 6 & 12 & 8 \\
8 & 10 & 6 & 8 & 2 & 8 & 8 & 6 & 6 & 8 & 8 & 10 & 8 & 6 & 10 & 8 \\
8 & 8 & 10 & 10 & 8 & 8 & 10 & 10 & 8 & 8 & 6 & 14 & 8 & 8 & 6 & 6 \\
8 & 6 & 10 & 12 & 8 & 10 & 10 & 8 & 6 & 8 & 8 & 6 & 10 & 8 & 12 & 6 \\
8 & 6 & 6 & 8 & 6 & 8 & 12 & 10 & 10 & 4 & 8 & 6 & 8 & 6 & 6 & 8 \\
8 & 8 & 10 & 10 & 6 & 6 & 8 & 8 & 8 & 8 & 6 & 6 & 2 & 10 & 8 & 8 \\
8 & 6 & 6 & 12 & 8 & 10 & 6 & 8 & 10 & 8 & 12 & 10 & 6 & 8 & 8 & 10 \\
8 & 8 & 10 & 6 & 8 & 8 & 10 & 6 & 8 & 4 & 10 & 10 & 8 & 12 & 10 & 10

\end{pmatrix}\]

\section*{Question 3}

Les probabilités les plus éloignées de 0.5 (hormis 1) sont 0.125 et 0.875.
Elles sont atteintes respectivement pour les couples :
\begin{enumerate}
\item $p_{3,15} = p_{7,7} = p_{9,4} = p_{13,12} = 0.125$
\item $p_{1,5} = p_{4,8} = p_{10,11} = 0.875$
\end{enumerate}

En effet, il n'est pas très intéressant de travailler avec le couple $(0,0)$, car dans ce cas $a.x = b.S(x) \Leftrightarrow 0 = 0$, ce qui n'est pas très expressif comme relation...

\section*{Question 4}

\underline{Remarque :} Comme la fin de la question le laisse suggérer, on suppose que les probabilités portent sur le message $m$, et que les clés $K_0$, $K_1$ et $K_2$ sont fixées.

Soit $m$ un message aléatoire distribué (en tant que variable aléatoire) uniformément sur %TODO

Avec les notations introduites dans l'énoncé, on a \[A.m = a.m^{(0)}\] et \[P(B).x_1 = P(B).F(x_0,K_1) = P(B).(P(S(x_0)\oplus K_1)\]

Soit $K_3$ telle que $K_1 = P(K_3)$. On a :


\[
    \begin{aligned}
        P(B).x_1 &= P(B).\left (P\left (S\left (x_0\right )\right )\oplus P(K_3)\right ) \\
        &= P\left (B\right ).P\left (S\left (x_0\right ) \oplus K_3\right )\\
        &= B.\left (S\left (x_0\right ) \oplus K_3\right ) \\
        &= b.\left (S\left (x_0^{\left (0\right )}\right ) \oplus K_3^{(0)}\right )
    \end{aligned}
\]

D'où $\prob{A.m = P(B).x_1} = \prob{a.m^{(0)}= b.(S(x_0^{(0)}) \oplus K_3^{(0)})}$.

Avec $x_0^{(0)} = m^{(0)} \oplus K_0^{(0)}$.

Pour se ramener aux probabilités introduites dans la matrice $L$ (i.e du type $\prob{a.y = b.S(y)}$), l'idée est d'observer que l'utilisation des clés ne changent pas la distribution uniforme.

\begin{lemma}
	Si $x$ est uniforme, alors $x \oplus K$ est uniforme pour tout clé $K$.
\end{lemma}

\begin{proof}
	Il suffit de montrer que chaque bit de $x \oplus K$ est uniformément distribué dans $\{0,1\}$.

	Soit $x_i$ un bit aléatoire de $x$. Le ième bit de $x \oplus K$ est $x_i \oplus K_i$.

	Si $K_i = 0$, $x_i \oplus K_i = x_i$ donc uniforme.

	Si $K_i = 1$, $x_i \oplus K_i = 1 - x_i$ également uniforme. 
\end{proof}

\begin{lemma}
	Si $x$ est uniforme, alors $S(x)$ et $P(x)$ aussi.
\end{lemma}
\begin{proof}
	Clair car $S$ et $P$ sont des bijections.
\end{proof}

Avec ces deux lemmes, on peut maintenant écrire :

\begin{align*}
\prob{a.m^{(0)}= b.\left (S\left (x_0^{(0)}\right ) \oplus K_3^{(0)}\right )} &= \prob{a.m^{(0)} = b.(S(x_0^{(0)}))} \\
													&= \prob{a.\left(x^{(0)} \oplus K_0^{(0)}\right ) =  b.\left (S\left (x_0^{(0)}\right )\right )} \\
													&= \prob{a.x^{(0)} = b.\left(S\left(x_0^{\left(0\right)}\right)\right)} \\
													&= \frac{1}{2} \pm \frac{6}{16}
\end{align*}
Car $0.125 = \frac{1}{2} - \frac{6}{16}$ et $0.875 = \frac{1}{2} + \frac{6}{16}$.

D'où $\prob{A.m = P(B).x_1} = \frac{1}{2} \pm \frac{6}{16}$, ce qui permet de conclure.

\section*{Question 5}

Selon la valeur de $b$, les bits non nuls de $P(B)$ peuvent correspondre à une ou deux Sboxes (le "ou" ayant un sens exclusif ici). C'est ce qu'on entend par les cas "une active box" et "deux active boxes" (notamment dans la question 8).

En effet, avec les $A$ et $B$ donnés, les seuls bits de $K_2$ qui vont intervenir dans le calcul de $P(B).x1$ sont les bits $i$ tels que $P(b)_i \neq 0$. Ces bits font forcément partis des bits de $b$, qui sont situés entre les rangs 2 et 6 (voir figure 
\ref{illustration_bits_key}).

Si les bits de $b$ valant $1$ occupent deux groupes de 4 bits différents (qui correspondent aux résultats de 2 boxes différentes), on est dans le "deux actives boxes". C'est le cas de la figure \ref{illustration_bits_key}. Dans ce cas, on peut se limiter à chercher les 8 premiers bits de la clé.


\begin{figure}[!ht]
\centering
\begin{tikzpicture}
	\draw[very thick] (8,1) -- (0,1) -- (0,0) -- (8,0) ;
	\draw[very thick] (4,0) -- (4,1);
	\draw[decorate,decoration={brace,raise=0.2cm}] (4,0) -- (0,0) node[below=0.4cm,pos=0.5] {output de la première box};
	\draw[decorate,decoration={brace,raise=0.2cm}] (8.1,0) -- (4.1,0) node[below=0.4cm,pos=0.5] {output de la seconde box};
	\draw (1,0) -- (1,1);
	\draw (2,0) -- (2,1);
	\draw (3,0) -- (3,1);
	\draw (5,0) -- (5,1);
	\draw (6,0) -- (6,1);
	\draw (7,0) -- (7,1);
	\draw[very thin] (0.5,0.5) node {$0$};
	\draw[very thin] (1.5,0.5) node {$0$};
	\draw[very thin,color=red] (2.5,0.5) node {$1$};
	\draw[very thin,color=red] (3.5,0.5) node {$1$};
	\draw[very thin,color=red] (4.5,0.5) node {$0$};
	\draw[very thin,color=red] (5.5,0.5) node {$1$};
	\draw[very thin] (6.5,0.5) node {$0$};
	\draw[very thin] (7.5,0.5) node {$\cdots$};
	\draw[dashed, very thick, color=red] (1.9,-0.1) -- (5.9,-0.1) -- (5.9,1.1) -- (1.9,1.1) -- cycle;
	\draw[color=red] (5.5,1.5) node {$b$};
	\draw (-0.5,0.5) node {$P(B)$};
\end{tikzpicture}
\caption{Ici on cherche à deviner 8 bits de $K_2$ (cas "deux actives boxes")}
\label{illustration_bits_key}
\end{figure}


S'ils occupent un seul groupe, alors on est dans le cas "une active boxe". On peut alors se limiter à deviner les 4 premiers bits (ou les 4 suivants selon $b$) de la clé $K_2$.

Il est facile de voir que l'on est dans le cas "une active boxe" si $b < 3$ (seuls les bits à droite sont non nuls), ou si $4$ divise $b$ (seuls les bits à gauche sont non nuls). 

L'algorithme, pour le cas "une active box", qui renvoit les 4 bits les plus probables pour la sous-clé qui nous intéresse est donné ci-dessous.

\begin{algorithm}
\caption{L'attaque des 4 bits de la clé pouvant être devinés, dans le cas "une active box"}
	\Entree{Des couples $(m,c)$}
	\Sortie{La sous-clé $K'_2$ la plus probable}
	\Pour{chaque couple $(a,b)$ de type "one active box"}
	{
		\Pour{chaque clé $K'_2 \in \{0,1\}^4$}
		{
			Calculer $x_1 = c \oplus K_2$ ($K_2$ = $K'_2$ complétée par des zéros ailleurs) \\
			\Si{$A.m = P(B).x_1$}{$Count[K'_2]$++}
		}
		$Guess(a,b) = Argmin \left( Count[.] \right)$
	}
	\Pour{chaque bit $i$ de la sous-clé à deviner}
	{
		Choisir $b$ tel que $b$ apparaît le plus souvent en ième position dans les $Guess(.,.)$.
	}
\end{algorithm}

\section*{Question 6}

Dans toute cette table, les bits de $m$ seron notés m = $m_0 m_1\cdots m_n$, et les bits de $x_1$ (que l'on renomme $x$) seront notés $x_1 = x_0 x_1 \cdots x_n$. On fera notamment attention au fait que, dans ce tableau, $x_1$ désignera le deuxième bit de $x$ fraichement renommé.

Par mesure de simplicité, on ne représente qu'une partie des bits nuls de P(B).

\begin{table}[!ht]
\centering
\begin{small}
\begin{tabular}{|c|c|c|c|c|c|}
	\hline
	$(a,b)$   & $p_{a,b}$ & 		$P(B)$ 	   & équation linéaire	 & \# d'active boxes & bits de $K_2$ à deviner \\
	\hline
	$(3,15)$  &   0.125   & $0011110\cdots0$ & $m_2 \oplus m_3 = x_0 \oplus x_1 \oplus x_2 \oplus x_3$ & 2 & 2, 3, 4, 5 \\
	\hline
	$(7,7)$   &   0.125   & $0001110\cdots0$ & $m_1 \oplus m_2 \oplus m_3 = x_1 \oplus x_2 \oplus x_3$ & 2 & 3, 4, 5\\
	\hline
	$(9,4)$   &   0.125   & $0001000\cdots0$ & $m_0 \oplus m_3 = x_1$ 								   & 1 & 3 \\
	\hline
	$(13,12)$ &   0.125   & $0011000\cdots0$ & $m_0 \oplus m_1 \oplus m_3 = x_0 \oplus x_1$ 		   & 1 & 2, 3 \\
	\hline
	$(1,5)$   &   0.875   & $0001010\cdots0$ & $m_3 = m_1 \oplus m_3$								   & 2 & 3, 5 \\
	\hline
	$(4,8)$   &   0.875   & $0010000\cdots0$ & $m_1 = x_0$ 											   & 1 & 2 \\
	\hline
	$(10,11)$ &   0.875   & $0010110\cdots0$ & $m_0 \oplus m_2 = x_0 \oplus x_2 \oplus x_3$			   & 2 & 2, 4, 5 \\
	\hline
\end{tabular}
\end{small}
\caption{Le tableau global regroupant tous les éléments nécessaires à l'attaque}
\end{table}

\section*{Question 7}

%TODO : Trouver le pari spécifique à un couple (a,b)

\section*{Question 8}

%TODO : Ici, il faudra comparer les deux méthodes par rapport à la vitesse d'exécution et au nombre d'opérations effectuées

\section*{Question 9}

Une fois que l'on a trouvé la clé $K_2$, on peut se ramener à l'étude d'un schéma de chiffrement utilisant seulement un tour de fonction $F$. Pour cela, il suffit, à partir de la clé trouvée et du fonctionnement des SBoxes, de retrouver $x_1 = F(x_0,K_1) = F^{-1}(c,K_2)$.

On a alors, dans ce schéma de chiffrement réduit, un jeu de couple $(m,x_1)$ où les $x_1$ correspondent au résultat du chiffrement de chaque $m$. On remarque alors que :

$$ \prob{A.m = B.S(x_0)} = \prob{A.m^{(0)} = b.S(x_0)^{(0)}} = \prob{A.m^{(0)} = b.S(x_0^{(0)})} $$

Or on avait établi dans la question 4, en tant que résult intermédiaire que :

$$ \prob{A.m^{(0)} = b.S(x_0^{(0)})} = \frac{1}{2} \pm \frac{6}{16}$$

Ainsi, on peut utiliser exactement la même méthode que précédemment afin de deviner la clé $K_1$, qui est la dernière clé utilisée dans le schéma de chiffrement réduit.

Une fois que l'on a trouvé $K_1$, il reste à trouver $K_0$. Cette opération consiste juste à vérifier que pour tout couple $(m,x_1)$ utilisé précédemment, on a avec la clé trouvée que $m \oplus F^{-1}(x_1,K_1) = m \oplus x_0 = K_0$ qui est un message constant, qui correspond à la clé recherchée.

A partir des trois clés $K_2$, $K_1$ et $K_0$, il est facile de retrouver la clé $K$ à partir de la table des permutations utilisées pour construire les trois clés. De plus, on peut vérifier pendant cette étape que l'on a effectivement bien trouver les bonnes clés lors des étapes précédentes.

%\section*{Question 10}

% Rappel : c'est uen question bonus, on peut faire seulement la théorie si le temps nous le permet.
\end{document}

